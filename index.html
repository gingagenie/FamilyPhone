<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FamilyPhone – Parent Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 960px;
      margin: 40px auto;
      background: #ffffff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }
    h1, h2 {
      margin-top: 0;
    }
    .row {
      margin-bottom: 24px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
      font-weight: 600;
    }
    input {
      padding: 8px 10px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 8px;
    }
    button {
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      background: #2563eb;
      color: white;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .flex {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .flex-between {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      background: #fafafa;
    }
    .messages {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      max-height: 260px;
      overflow-y: auto;
      background: #0f172a;
      color: #e5e7eb;
      font-size: 14px;
    }
    .msg {
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(148,163,184,0.4);
    }
    .msg:last-child {
      border-bottom: none;
    }
    .msg-meta {
      font-size: 11px;
      opacity: 0.7;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .badge-parent {
      background: #22c55e33;
      color: #22c55e;
    }
    .badge-kid {
      background: #f9731633;
      color: #f97316;
    }
    .muted {
      opacity: 0.7;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="flex-between row">
      <div>
        <h1>FamilyPhone – Parent Dashboard (Prototype)</h1>
        <p id="user-info" class="muted"></p>
      </div>
      <div>
        <button id="sign-out-btn" style="display:none;">Sign out</button>
      </div>
    </header>

    <!-- AUTH SECTION -->
    <section id="auth-section" class="row">
      <h2>Sign in / Sign up</h2>
      <form id="auth-form">
        <label>Email</label>
        <input type="email" id="auth-email" required placeholder="you@example.com" />
        <label>Password</label>
        <input type="password" id="auth-password" required placeholder="••••••••" />
        <div class="flex">
          <button type="submit" id="sign-in-btn">Sign in</button>
          <button type="button" class="secondary" id="sign-up-btn">Sign up</button>
        </div>
      </form>
      <p class="muted" style="margin-top:8px;">
        This is a dev prototype. Use a throwaway email/password while testing.
      </p>
      <p id="auth-status" class="muted"></p>
    </section>

    <!-- APP SECTION -->
    <section id="app-section" style="display:none;">
      <!-- FAMILY INFO -->
      <div class="row flex-between">
        <div>
          <h2>Family</h2>
          <p id="family-name" class="muted"></p>
        </div>
        <div>
          <button id="create-family-btn">Create family</button>
        </div>
      </div>

      <!-- KIDS -->
      <div class="row">
        <h2>Kids</h2>
        <div id="kids-list" class="muted">Loading kids…</div>
        <form id="kid-form" class="flex" style="margin-top:8px;">
          <input
            type="text"
            id="kid-name"
            placeholder="New kid name (e.g. Charlie)"
          />
          <button type="submit">Add kid</button>
        </form>
      </div>

      <!-- CHAT -->
      <div class="row">
        <div class="flex-between">
          <h2>Family Chat</h2>
          <button class="secondary" id="refresh-messages-btn">Refresh</button>
        </div>
        <div id="messages" class="messages">
          <p class="muted">No messages yet.</p>
        </div>
        <form id="message-form" class="flex" style="margin-top:8px;">
          <input
            type="text"
            id="message-text"
            placeholder="Type a message to your family…"
          />
          <button type="submit">Send</button>
        </form>
      </div>
    </section>
  </div>

  <!-- Supabase JS via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://jllzjhebldumlcqofxpl.supabase.co"; // TODO: replace
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsbHpqaGVibGR1bWxjcW9meHBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MzQwMTUsImV4cCI6MjA3OTQxMDAxNX0.2K1HpiUJumjX7gRMNbG5jCMo_C2-EeHNhIL8aUgVE1g";          // TODO: replace

    const { createClient } = supabase;
    const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== DOM ELEMENTS ======
    const userInfoEl = document.getElementById("user-info");
    const signOutBtn = document.getElementById("sign-out-btn");

    const authSection = document.getElementById("auth-section");
    const authForm = document.getElementById("auth-form");
    const authEmail = document.getElementById("auth-email");
    const authPassword = document.getElementById("auth-password");
    const signInBtn = document.getElementById("sign-in-btn");
    const signUpBtn = document.getElementById("sign-up-btn");
    const authStatus = document.getElementById("auth-status");

    const appSection = document.getElementById("app-section");
    const familyNameEl = document.getElementById("family-name");
    const createFamilyBtn = document.getElementById("create-family-btn");

    const kidsListEl = document.getElementById("kids-list");
    const kidForm = document.getElementById("kid-form");
    const kidNameInput = document.getElementById("kid-name");

    const messagesEl = document.getElementById("messages");
    const refreshMessagesBtn = document.getElementById("refresh-messages-btn");
    const messageForm = document.getElementById("message-form");
    const messageTextInput = document.getElementById("message-text");

    let currentUser = null;
    let currentFamily = null;

    // ====== AUTH HANDLING ======

    async function checkSession() {
      const { data, error } = await client.auth.getSession();
      if (error) {
        console.error("getSession error", error);
        return;
      }
      if (data.session?.user) {
        currentUser = data.session.user;
        userInfoEl.textContent = "Logged in as " + currentUser.email;
        signOutBtn.style.display = "inline-block";
        authSection.style.display = "none";
        appSection.style.display = "block";
        await loadFamilyAndData();
      } else {
        currentUser = null;
        userInfoEl.textContent = "Not signed in";
        signOutBtn.style.display = "none";
        authSection.style.display = "block";
        appSection.style.display = "none";
      }
    }

    // On page load
    checkSession();

    // Auth event listener (login/logout in this tab)
    client.auth.onAuthStateChange((_event, session) => {
      if (session?.user) {
        currentUser = session.user;
      } else {
        currentUser = null;
      }
      checkSession();
    });

    authForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      authStatus.textContent = "";
      const email = authEmail.value.trim();
      const password = authPassword.value.trim();
      if (!email || !password) {
        authStatus.textContent = "Email and password required.";
        return;
      }
      signInBtn.disabled = true;

      const { error } = await client.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        console.error("Sign in error", error);
        authStatus.textContent = "Sign in failed: " + error.message;
      } else {
        authStatus.textContent = "Signed in!";
      }
      signInBtn.disabled = false;
    });

    signUpBtn.addEventListener("click", async () => {
      authStatus.textContent = "";
      const email = authEmail.value.trim();
      const password = authPassword.value.trim();
      if (!email || !password) {
        authStatus.textContent = "Email and password required.";
        return;
      }
      signUpBtn.disabled = true;
      const { data, error } = await client.auth.signUp({
        email,
        password,
      });
      if (error) {
        console.error("Sign up error", error);
        authStatus.textContent = "Sign up failed: " + error.message;
      } else {
        authStatus.textContent = data.session
          ? "Signed up & logged in!"
          : "Sign up successful. Check your email to confirm.";
      }
      signUpBtn.disabled = false;
    });

    signOutBtn.addEventListener("click", async () => {
      await client.auth.signOut();
    });

    // ====== FAMILY / KIDS / MESSAGES ======

    async function loadFamilyAndData() {
      if (!currentUser) return;
      familyNameEl.textContent = "Loading family…";
      kidsListEl.textContent = "Loading kids…";
      messagesEl.innerHTML = '<p class="muted">Loading messages…</p>';

      // 1) Load families (RLS ensures only this user's families)
      const { data: families, error: famErr } = await client
        .from("families")
        .select("*")
        .order("created_at", { ascending: true });

      if (famErr) {
        console.error("Load families error", famErr);
        familyNameEl.textContent = "Error loading families";
        return;
      }

      if (!families || families.length === 0) {
        currentFamily = null;
        familyNameEl.textContent = "No family created yet.";
        kidsListEl.textContent = "Add kids after creating a family.";
        messagesEl.innerHTML = '<p class="muted">Create a family to start chatting.</p>';
        return;
      }

      currentFamily = families[0];
      familyNameEl.textContent = currentFamily.name + " (" + currentFamily.id + ")";

      await loadKids();
      await loadMessages();
    }

    async function loadKids() {
      if (!currentFamily) return;
      const { data, error } = await client
        .from("kids")
        .select("*")
        .eq("family_id", currentFamily.id)
        .order("created_at", { ascending: true });

      if (error) {
        console.error("Load kids error", error);
        kidsListEl.textContent = "Error loading kids.";
        return;
      }

      if (!data || data.length === 0) {
        kidsListEl.textContent = "No kids added yet.";
        return;
      }

      const html = data
        .map(
          (kid) =>
            `<div class="card"><strong>${kid.display_name}</strong><br/><span class="muted">${kid.id}</span></div>`
        )
        .join("");
      kidsListEl.innerHTML = html;
    }

    async function loadMessages() {
      if (!currentFamily) return;
      const { data, error } = await client
        .from("messages")
        .select("*")
        .eq("family_id", currentFamily.id)
        .order("created_at", { ascending: true });

      if (error) {
        console.error("Load messages error", error);
        messagesEl.innerHTML = '<p class="muted">Error loading messages.</p>';
        return;
      }

      if (!data || data.length === 0) {
        messagesEl.innerHTML = '<p class="muted">No messages yet.</p>';
        return;
      }

      const html = data
        .map((msg) => {
          const date = new Date(msg.created_at).toLocaleString();
          const badgeClass =
            msg.sender_type === "kid" ? "badge-kid" : "badge-parent";
          return `
            <div class="msg">
              <div class="msg-meta">
                <span class="badge ${badgeClass}">${msg.sender_type}</span>
                &nbsp;${date}
              </div>
              <div>${msg.text || ""}</div>
            </div>
          `;
        })
        .join("");
      messagesEl.innerHTML = html;
    }

    createFamilyBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      const name = window.prompt("Family name?", "Richmond Family");
      if (!name) return;
      createFamilyBtn.disabled = true;
      try {
        const { data, error } = await client
          .from("families")
          .insert({
            name,
            created_by: currentUser.id,
          })
          .select()
          .single();
        if (error) throw error;

        // Add as parent in family_members
        const { error: memErr } = await client.from("family_members").insert({
          family_id: data.id,
          user_id: currentUser.id,
          role: "parent",
        });
        if (memErr) throw memErr;

        await loadFamilyAndData();
      } catch (err) {
        console.error("Create family error", err);
        alert("Failed to create family – check console / RLS.");
      } finally {
        createFamilyBtn.disabled = false;
      }
    });

    kidForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentFamily) {
        alert("Create a family first.");
        return;
      }
      const name = kidNameInput.value.trim();
      if (!name) return;
      kidNameInput.disabled = true;
      try {
        const { error } = await client.from("kids").insert({
          family_id: currentFamily.id,
          display_name: name,
        });
        if (error) throw error;
        kidNameInput.value = "";
        await loadKids();
      } catch (err) {
        console.error("Add kid error", err);
        alert("Failed to add kid – check console / RLS.");
      } finally {
        kidNameInput.disabled = false;
      }
    });

    messageForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!currentFamily || !currentUser) return;
      const text = messageTextInput.value.trim();
      if (!text) return;
      messageTextInput.disabled = true;
      try {
        const { error } = await client.from("messages").insert({
          family_id: currentFamily.id,
          sender_type: "parent",
          sender_user_id: currentUser.id,
          text,
          has_attachments: false,
        });
        if (error) throw error;
        messageTextInput.value = "";
        await loadMessages();
      } catch (err) {
        console.error("Send message error", err);
        alert("Failed to send message – check console / RLS.");
      } finally {
        messageTextInput.disabled = false;
      }
    });

    refreshMessagesBtn.addEventListener("click", loadMessages);
  </script>
</body>
</html>
